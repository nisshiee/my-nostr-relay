# Implementation Plan

## Tasks

- [x] 1. (P) 削除対象の表現と抽出機能を実装
  - 削除リクエストイベントから削除対象を抽出するデータ構造を作成
  - イベントID指定（eタグ）とAddressable指定（aタグ）の両方に対応
  - aタグのフォーマット（kind:pubkey:d_tag）を検証し、不正な形式はスキップ
  - aタグ内のpubkeyと削除リクエストのpubkeyを比較し、不一致は早期フィルタリング
  - 削除リクエストのpubkeyとcreated_atを各削除対象に保持
  - _Requirements: 1.2, 1.3_

- [x] 2. (P) 削除可否の検証ロジックを実装
  - pubkey一致検証：削除対象イベントの所有者と削除リクエスト送信者の一致を判定
  - kind:5保護判定：削除リクエスト自体を削除対象から保護（NIP-09仕様）
  - 時刻境界検証：Addressable削除において削除リクエストのcreated_at以前のイベントのみ対象
  - 外部依存を持たない純粋関数として実装
  - _Requirements: 2.2, 3.2, 3.3, 5.1_

- [x] 3. イベントリポジトリに削除機能を追加
- [x] 3.1 (P) リポジトリトレイトに削除メソッドを追加
  - イベントID指定の物理削除メソッドを追加（存在しない場合はfalseを返す）
  - Addressable識別子（pubkey, kind, d_tag）と時刻境界による削除メソッドを追加
  - 削除操作は冪等性を持つ設計（エラーではなく結果を返す）
  - _Requirements: 2.1, 3.1_

- [x] 3.2 DynamoDB削除処理を実装
  - DeleteItemを使用したイベントID指定の物理削除
  - GSI-PkKindDでクエリし、時刻条件（created_at以前）に合致するイベントを取得
  - BatchWriteItemで複数イベントの一括削除
  - DynamoDB Streams経由でOpenSearchからも自動削除される（既存Indexer活用）
  - Task 3.1完了後に開始
  - _Requirements: 2.1, 2.4, 2.5, 3.1, 3.3, 3.4, 6.1_

- [x] 3.3 (P) モックリポジトリにテスト用削除機能を追加
  - インメモリストレージからのイベント削除
  - 単体テスト・統合テストで使用可能な実装
  - Task 3.1完了後に開始、Task 3.2と並行実行可能
  - _Requirements: 2.1, 3.1_

- [ ] 4. 削除処理の統合
- [ ] 4.1 削除処理モジュールを実装
  - 削除対象の抽出、検証、削除実行を統括するモジュールを作成
  - eタグ対象：イベント取得 → pubkey検証 → kind:5保護チェック → 物理削除
  - aタグ対象：Addressable検索 → 時刻境界フィルタ → 物理削除
  - 削除対象が存在しない場合やpubkey不一致の場合はスキップして継続
  - 削除対象がkind:5の場合はスキップ（削除リクエストの削除を防止）
  - 全削除処理完了後、削除リクエストイベント自体を保存
  - Tasks 1, 2, 3.2, 3.3完了後に開始
  - _Requirements: 2.1, 2.2, 2.3, 3.1, 3.2, 4.1, 5.1, 5.2_

- [ ] 4.2 イベントハンドラーにkind:5分岐を追加
  - 署名検証後、kind:5の場合は削除処理モジュールに委譲
  - 削除処理成功時はOK(true)を返却
  - 署名無効時はOK(false, "invalid:")を返却
  - 削除リクエストイベント（kind:5）をkind:5にマッチするサブスクリプションへ配信
  - 既存のKind分類ロジック（Regular/Replaceable/Ephemeral/Addressable）は維持
  - Task 4.1完了後に開始
  - _Requirements: 1.1, 1.4, 1.5, 4.2, 4.3, 6.2_

- [ ] 5. テストの実装
- [ ] 5.1 (P) ドメイン層のユニットテスト
  - 削除対象抽出：eタグのみ、aタグのみ、混在、不正フォーマット、pubkey不一致フィルタ
  - pubkey検証：一致・不一致の判定
  - kind保護：kind:5の保護判定、他kindの許可
  - 時刻境界：境界値（以前・以降）の判定
  - _Requirements: 1.2, 1.3, 2.2, 3.2, 3.3, 5.1_

- [ ] 5.2 削除処理の統合テスト
  - EventHandler経由のkind:5処理フロー（正常系・異常系）
  - 通常イベント削除：存在するイベント、存在しないイベント、pubkey不一致
  - Addressableイベント削除：時刻境界内、時刻境界外、複数バージョン
  - kind:5保護：削除リクエストの削除リクエストは対象イベントを削除しない
  - 削除リクエストイベント自体の保存・配信確認
  - 物理削除後のクエリで削除済みイベントが返らないことを確認
  - _Requirements: 1.1, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 5.1, 5.2, 6.1, 6.2_

## Requirements Coverage

| Requirement | Task(s) | Notes |
|-------------|---------|-------|
| 1.1 | 4.2 | 署名検証は既存実装を利用 |
| 1.2 | 1 | eタグ解析 |
| 1.3 | 1 | aタグ解析 |
| 1.4 | 4.2 | OK(true)返却 |
| 1.5 | 4.2 | OK(false, invalid:)返却 |
| 2.1 | 3.1, 3.2, 4.1 | 物理削除処理 |
| 2.2 | 2, 4.1 | pubkey検証 |
| 2.3 | 4.1 | 存在しないイベントのスキップ |
| 2.4 | 3.2 | 削除後のクエリ除外 |
| 2.5 | 3.2 | 既存Indexer実装で対応済み |
| 3.1 | 3.1, 3.2, 4.1 | Addressable物理削除 |
| 3.2 | 2, 4.1 | aタグpubkey検証 |
| 3.3 | 2, 3.2 | 時刻境界検証 |
| 3.4 | 3.2 | 既存Indexer実装で対応済み |
| 4.1 | 4.1 | 削除リクエスト保存 |
| 4.2 | 4.2 | kind:5配信 |
| 4.3 | 4.2 | 無期限保存・配信（既存save/query利用） |
| 5.1 | 2, 4.1 | kind:5保護 |
| 5.2 | 4.1 | 削除リクエスト自体の保存 |
| 6.1 | 3.2 | 物理削除によるクエリ除外 |
| 6.2 | 4.2 | サブスクリプション配信 |

## Parallel Execution Notes

- **Phase 1 (並列)**: Tasks 1, 2, 3.1 は相互依存がなく並列実行可能
- **Phase 2 (並列)**: Tasks 3.2, 3.3 は Task 3.1 完了後に並列実行可能
- **Phase 3 (直列)**: Task 4.1 は Tasks 1, 2, 3.2, 3.3 の全完了が必要
- **Phase 4 (直列)**: Task 4.2 は Task 4.1 完了後に実行
- **Phase 5 (並列)**: Tasks 5.1, 5.2 は異なるテストスコープのため並列実行可能

# Implementation Plan

## Task 1: 制限値設定のドメインモデル実装
- [x] 1.1 制限値を保持する設定構造体を作成する
  - 9つの制限値フィールド（メッセージ長、サブスクリプション数、limit値、タグ数、コンテンツ長、サブスクリプションID長、created_at下限・上限、デフォルトlimit）を持つ構造体を定義
  - 各フィールドに仕様で定められたデフォルト値を設定
  - サブスクリプションID長は64固定とし、環境変数での変更は不可
  - _Requirements: 2.9_

- [x] 1.2 環境変数からの制限値読み込み機能を実装する
  - 環境変数から各制限値を読み込むメソッドを実装
  - 環境変数が未設定の場合はデフォルト値にフォールバック
  - パースエラー時もデフォルト値を使用しサービス継続を優先
  - 設定値読み込み時にログ出力して設定状況を可視化
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8_

## Task 2: NIP-11 limitation構造体の拡張
- [x] 2.1 (P) NIP-11 limitationオブジェクトのフィールドを拡張する
  - 既存のmax_subid_lengthに加え、8つの新規フィールドを追加
  - JSON出力時のフィールド名をNIP-11仕様に合わせる
  - Serdeによるシリアライズを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9_

- [x] 2.2 (P) 制限値設定からlimitationオブジェクトを構築する変換機能を実装する
  - Task 1で作成した設定構造体からlimitationオブジェクトへの変換メソッドを実装
  - 全フィールドが正しくマッピングされることを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9_

## Task 3: NIP-11ハンドラへの制限値統合
- [x] 3. NIP-11レスポンスに全制限値を含める
  - NIP-11ハンドラに制限値設定を注入
  - リレー情報ドキュメント生成時に拡張されたlimitationオブジェクトを使用
  - HTTPレスポンスで全9フィールドが出力されることを確認
  - 既存の設定読み込み処理と統合
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9_

## Task 4: イベントバリデーションの制限チェック拡張
- [x] 4.1 (P) バリデーションエラー種別を拡張する
  - タグ数超過エラーを追加（制限値と実際の数を含む）
  - コンテンツ長超過エラーを追加（制限値と実際の長さを含む）
  - created_at過去すぎエラーを追加（経過秒数と制限値を含む）
  - created_at未来すぎエラーを追加（先行秒数と制限値を含む）
  - エラーメッセージは人間が読みやすい形式で
  - _Requirements: 3.4, 3.5, 3.6, 3.7_

- [x] 4.2 (P) イベントの制限値バリデーション機能を実装する
  - タグ配列の要素数がmax_event_tags以下かチェック
  - コンテンツの文字数がmax_content_length以下かチェック（Unicode文字数でカウント）
  - created_atが現在時刻からcreated_at_lower_limit秒以内の過去かチェック
  - created_atが現在時刻からcreated_at_upper_limit秒以内の未来かチェック
  - 既存のバリデーション処理（構造・ID・署名検証）の後に制限値チェックを追加
  - _Requirements: 3.4, 3.5, 3.6, 3.7_

## Task 5: サブスクリプションリポジトリの拡張
- [ ] 5.1 (P) サブスクリプションの存在確認機能を実装する
  - 接続IDとサブスクリプションIDを指定して存在を確認するメソッドを追加
  - DynamoDBのGetItemで効率的に確認
  - 既存サブスクリプションの更新かどうかの判定に使用
  - _Requirements: 3.2_

- [ ] 5.2 (P) 接続ごとのサブスクリプション数カウント機能を実装する
  - 接続IDを指定してサブスクリプション数を取得するメソッドを追加
  - DynamoDBのQueryでSelect COUNTを使用し効率的にカウント
  - エラー時は適切なリポジトリエラーを返却
  - _Requirements: 3.2_

## Task 6: サブスクリプションハンドラへの制限適用
- [ ] 6.1 サブスクリプション数制限を適用する
  - REQ処理前にサブスクリプション存在確認を実行
  - 新規サブスクリプションの場合のみ接続のサブスクリプション数をカウント
  - 既存サブスクリプションIDへのREQ（フィルター更新）はカウントチェックをスキップ
  - max_subscriptions超過時はCLOSEDメッセージで「too many subscriptions」を返却
  - _Requirements: 3.2, 3.2a_

- [ ] 6.2 サブスクリプションID長の検証を実装する
  - REQ処理の最初にサブスクリプションIDの長さをチェック
  - max_subid_length（64）を超える場合はCLOSEDメッセージで拒否
  - CLOSEDメッセージには「subscription id too long」の説明を含める
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 6.3 フィルターlimit値の制限を適用する
  - フィルターのlimit値がmax_limitを超える場合はmax_limitにクランプ
  - フィルターにlimitが指定されていない場合はdefault_limitを適用
  - クランプ・デフォルト適用はサイレントに行う（エラーではない）
  - _Requirements: 3.3, 1.10_

## Task 7: イベントハンドラへの制限バリデーション統合
- [ ] 7. イベント投稿時に制限値バリデーションを適用する
  - EVENTメッセージ処理時にTask 4で実装した制限値バリデーションを呼び出す
  - タグ数超過時は「invalid: too many tags」でOK false応答
  - コンテンツ長超過時は「invalid: content too long」でOK false応答
  - created_at範囲外時は「invalid: created_at out of range」でOK false応答
  - 既存のバリデーションエラーハンドリングパターンに従う
  - _Requirements: 3.4, 3.5, 3.6, 3.7_

## Task 8: 統合テストの実装
- [ ] 8.1 制限値設定のユニットテストを実装する
  - デフォルト値が仕様通りか確認
  - 環境変数からの読み込みが正しく動作するか確認
  - パースエラー時のフォールバック動作を確認
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9_

- [ ] 8.2 イベントバリデーションのユニットテストを実装する
  - タグ数境界値テスト（制限値-1、制限値、制限値+1）
  - コンテンツ長境界値テスト（マルチバイト文字を含む）
  - created_at境界値テスト（下限・上限それぞれ）
  - _Requirements: 3.4, 3.5, 3.6, 3.7_

- [ ] 8.3 サブスクリプション制限の統合テストを実装する
  - サブスクリプション数上限到達時のCLOSED応答確認
  - 既存サブスクリプション更新時はカウントチェックをスキップすることを確認
  - サブスクリプションID長超過時のCLOSED応答確認
  - limit値クランプ動作の確認
  - default_limit適用の確認
  - _Requirements: 3.2, 3.2a, 3.3, 1.10, 4.1, 4.2, 4.3_

- [ ] 8.4 NIP-11レスポンスの統合テストを実装する
  - レスポンスに全9つのlimitationフィールドが含まれることを確認
  - 各フィールドの値が設定値と一致することを確認
  - 環境変数によるオーバーライドが反映されることを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 1.10_
